version: "3.8"
volumes:
  micro_db_vol: # 定义mysql数据卷
  micro_redis_vol: #定义redis数据卷
  micro_media_vol: #定义用户上传的数据卷
services:
  db:
    image: mysql:5.7
    environment:
      - MYSQL_ROOT_PASSWORD=19990426 # 数据库密码
      - MYSQL_DATABASE=wallpaper # 数据库名称
      - MYSQL_USER=shentu # 数据库用户名
      - MYSQL_PASSWORD=19951008 # 用户密码
    volumes:
      - micro_db_vol:/var/lib/mysql:rw # 挂载数据库数据, 可读可写
      - ./compose/mysql/conf/my.cnf:/etc/mysql/my.cnf # 挂载配置文件
      - ./compose/mysql/init:/docker-entrypoint-initdb.d/ # 挂载数据初始化sql脚本
    ports:
      - "3306:3306" # 与配置文件保持一致
    restart: always
  web:
    build: ./micro_web
    ports:
      - "8000:8000"
    volumes:
      - ./micro_web:/home/shentu/micro_web # 挂载项目代码
      - micro_media_vol:/home/shentu/micro_web/media # 以数据卷挂载容器内用户上传媒体文件
      - ./compose/uwsgi:/tmp # 挂载uwsgi日志
    links:
      - db
    depends_on: # 依赖关系
      - db
    environment:
      - DEBUG=False
    restart: always
    tty: true
    stdin_open: true

#  nginx:
#    build: ./compose/nginx
#    ports:
#      - "80:80"
#      - "443:443"
#    expose:
#      - "80"
#    volumes:
#      - ./micro_web/static:/usr/share/nginx/html/static # 挂载静态文件
#      - ./compose/nginx/ssl:/usr/share/nginx/ssl # 挂载ssl证书目录
#      - ./compose/nginx/log:/var/log/nginx # 挂载日志
#      - micro_media_vol:/usr/share/nginx/html/media # 挂载用户上传媒体文件
#    links:
#      - web
#    depends_on:
#      - web
#    restart: always
